#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "🔍 Running Todo-Tracker pre-push validation..."

# 1. Run all tests with coverage
echo "🧪 Running full test suite..."
if ! pnpm test; then
  echo "❌ Tests failed - push rejected"
  exit 1
fi

# 2. Verify code coverage above 90%
echo "📊 Checking code coverage..."
COVERAGE=$(node -e "console.log(require('./coverage/coverage-summary.json').total.lines.pct)")
if [ $(echo "$COVERAGE < 90" | bc -l) -eq 1 ]; then
  echo "❌ Coverage ${COVERAGE}% < 90% - push rejected"
  exit 1
fi

# 3. Lint staged files
echo "📝 Scanning for pending TODOs..."
if ! pnpm run check-todos; then
  echo "❌ Pending TODOs found - push aborted."
  echo "   Use '// TODO-ALLOW-PUSH:' to bypass for critical fixes."
  exit 1
fi

echo "✅ All checks passed! Pushing changes..."